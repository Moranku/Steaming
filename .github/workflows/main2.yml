name: Cloudflare noVNC Windows

on:
  workflow_dispatch:

jobs:
  win-novnc:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Enable Remote Desktop
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Write-Host "‚úÖ RDP enabled"

      - name: Create User
        run: |
          $pass = -join ((33..126) | Get-Random -Count 14 | ForEach-Object {[char]$_})
          $sec = ConvertTo-SecureString $pass -AsPlainText -Force
          New-LocalUser -Name "rdpuser" -Password $sec -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "rdpuser"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "rdpuser"
          echo "USER=rdpuser" >> $env:GITHUB_ENV
          echo "PASS=$pass" >> $env:GITHUB_ENV
          Write-Host "‚úÖ User created: rdpuser"

      - name: Install noVNC
        run: |
          Invoke-WebRequest -Uri "https://github.com/novnc/noVNC/archive/refs/heads/master.zip" -OutFile "$env:TEMP\novnc.zip"
          Expand-Archive "$env:TEMP\novnc.zip" -DestinationPath "C:\noVNC"
          Rename-Item "C:\noVNC\noVNC-master" "C:\noVNC\www"
          Write-Host "‚úÖ noVNC downloaded"

      - name: Install Websockify
        run: |
          Invoke-WebRequest -Uri "https://github.com/novnc/websockify/archive/refs/heads/master.zip" -OutFile "$env:TEMP\websockify.zip"
          Expand-Archive "$env:TEMP\websockify.zip" -DestinationPath "C:\noVNC"
          Rename-Item "C:\noVNC\websockify-master" "C:\noVNC\websockify"
          Write-Host "‚úÖ Websockify installed"

      - name: Download Cloudflare Tunnel
        run: |
          Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" `
                            -OutFile "C:\cloudflared.exe"
          Write-Host "‚úÖ Cloudflared ready"

      - name: Start noVNC and Tunnel
        run: |
          # Start websockify proxy for RDP
          Start-Process -NoNewWindow -FilePath "python" `
            -ArgumentList "C:\noVNC\websockify\run", "6080", "localhost:3389"
          Start-Sleep -Seconds 5
          Write-Host "üåê noVNC running on port 6080"

          # Start Cloudflare tunnel to expose port 6080
          Start-Process -NoNewWindow -FilePath "C:\cloudflared.exe" `
            -ArgumentList "tunnel --url http://localhost:6080"
          Start-Sleep -Seconds 10

          Write-Host "‚úÖ Tunnel running"
          Write-Host ""
          Write-Host "============================"
          Write-Host "üåç Open this link in your browser (Android works):"
          Write-Host "‚û°Ô∏è  Look in logs for a 'trycloudflare.com' URL"
          Write-Host ""
          Write-Host "üßë User: $env:USER"
          Write-Host "üîë Password: $env:PASS"
          Write-Host "============================"

          while ($true) {
            Start-Sleep -Seconds 300
          }

      - name: Keep alive
        run: |
          while ($true) {
            Start-Sleep -Seconds 600
          }
